<!DOCTYPE html>
<html lang="is">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta name="referrer" content="no-referrer">
    <title>B√≥kasafni√∞ Okkar - Sk√Ωjavistun</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Fredoka+One&family=Quicksand:wght@400;600&display=swap" rel="stylesheet">
    
    <!-- Firebase SDKs -->
    <script src="https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js" type="module"></script>
    <script src="https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js" type="module"></script>
    <script src="https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js" type="module"></script>

    <style>
        body { font-family: 'Quicksand', sans-serif; background-color: #f0f9ff; }
        h1, h2, h3 { font-family: 'Fredoka One', cursive; }
        .book-card { transition: transform 0.3s ease, box-shadow 0.3s ease; position: relative; display: flex; flex-direction: column; }
        .book-card:hover { transform: translateY(-5px); box-shadow: 0 15px 30px -5px rgba(0,0,0,0.1); }
        
        /* S√©rstakir litir fyrir flokka */
        .filter-btn.active { color: white; }
        .filter-btn[data-filter="all"].active { background-color: #3b82f6; border-color: #3b82f6; }
        .filter-btn[data-filter="samskipti og samb√∂nd"].active { background-color: #ec4899; border-color: #ec4899; }
        .filter-btn[data-filter="t√≥nlist"].active { background-color: #eab308; border-color: #eab308; }
        .filter-btn[data-filter="√≠√ær√≥ttir"].active { background-color: #10b981; border-color: #10b981; }
        .filter-btn[data-filter="√¶vint√Ωri"].active { background-color: #a855f7; border-color: #a855f7; }
        .filter-btn[data-filter="spenna"].active { background-color: #ef4444; border-color: #ef4444; }
        .filter-btn[data-filter="hrollvekja"].active { background-color: #6366f1; border-color: #6366f1; }
        .filter-btn[data-filter="fyndi√∞"].active { background-color: #f97316; border-color: #f97316; }
        
        .filter-btn[data-filter="favorites"].active { background-color: #ec4899; border-color: #ec4899; }
        .filter-btn[data-filter="read"].active { background-color: #10b981; border-color: #10b981; }

        .glass-nav { background: rgba(255, 255, 255, 0.9); backdrop-filter: blur(10px); }
        .description-text { display: -webkit-box; -webkit-line-clamp: 6; -webkit-box-orient: vertical; overflow: hidden; line-height: 1.5; }
        .action-btn { transition: all 0.2s ease; cursor: pointer; }
        .action-btn:hover { transform: scale(1.3); }
        
        @keyframes celebrate { 0% { transform: scale(1); } 50% { transform: scale(1.1); } 100% { transform: scale(1); } }
        .celebrate { animation: celebrate 0.5s ease-in-out; }
        .modal { background: rgba(0,0,0,0.5); backdrop-filter: blur(4px); }
        .progress-bar { transition: width 1s ease-in-out; }
    </style>
</head>
<body class="text-gray-800">

    <!-- Innskr√°ningar Modal -->
    <div id="authModal" class="fixed inset-0 z-[100] flex items-center justify-center modal hidden">
        <div class="bg-white p-8 rounded-3xl shadow-2xl max-w-sm w-full mx-4 text-center border-4 border-blue-400">
            <h2 id="modalTitle" class="text-3xl text-blue-600 mb-4">H√¶! Hver ert √æ√∫?</h2>
            <p class="text-gray-500 mb-6">Sl√°√∞u inn nafn og leynior√∞ til a√∞ geyma b√¶kurnar √æ√≠nar.</p>
            <input type="text" id="usernameInput" placeholder="Nafn" class="w-full px-4 py-3 rounded-xl border-2 border-blue-100 mb-3 focus:border-blue-400 outline-none">
            <input type="password" id="passwordInput" placeholder="Leynior√∞" class="w-full px-4 py-3 rounded-xl border-2 border-blue-100 mb-6 focus:border-blue-400 outline-none">
            <button id="authSubmitBtn" class="w-full py-3 bg-blue-500 text-white font-bold rounded-xl hover:bg-blue-600 transition-all shadow-lg">Byrja √¶vint√Ωri√∞!</button>
        </div>
    </div>

    <nav class="glass-nav sticky top-0 z-50 p-4 shadow-md border-b border-blue-100">
        <div class="max-w-6xl mx-auto">
            <div class="flex flex-col md:flex-row justify-between items-center gap-4">
                <div class="flex items-center gap-4">
                    <h1 class="text-2xl text-blue-600 tracking-wider">üìö B√≥kaheimurinn</h1>
                    <button id="userBtn" class="text-sm bg-blue-50 px-4 py-1.5 rounded-full text-blue-700 font-bold border border-blue-200 hover:bg-blue-100 transition-colors">üë§ Gestur</button>
                </div>
                
                <div class="flex flex-col items-center">
                    <div id="starsCounter" class="bg-yellow-100 px-6 py-2 rounded-full border-2 border-yellow-400 flex items-center gap-2 mb-1">
                        <span class="text-xl">‚≠ê</span>
                        <span class="font-bold text-yellow-700"><span id="readCount">0</span> b√¶kur lesnar!</span>
                    </div>
                    <div class="w-48 bg-gray-200 rounded-full h-2 overflow-hidden border border-gray-300 shadow-inner">
                        <div id="readingProgress" class="progress-bar bg-green-500 h-full w-0"></div>
                    </div>
                </div>

                <div class="w-full md:w-64">
                    <input type="text" id="searchInput" placeholder="Leita a√∞ b√≥k..." class="w-full px-4 py-2 rounded-full border-2 border-blue-200 focus:border-blue-400 outline-none transition-all shadow-inner">
                </div>
            </div>
        </div>
    </nav>

    <main class="max-w-6xl mx-auto p-6">
        <header class="text-center my-10">
            <h2 class="text-4xl md:text-5xl text-blue-600 mb-8">Hva√∞ √¶tlum vi√∞ a√∞ lesa?</h2>
            
            <div class="grid grid-cols-1 md:grid-cols-2 gap-4 max-w-2xl mx-auto mb-10">
                <button id="randomBookBtn" class="px-6 py-4 bg-purple-500 text-white font-bold rounded-2xl shadow-lg hover:bg-purple-600 transition-all transform hover:scale-105 flex items-center justify-center gap-3">
                    <span class="text-2xl">üé≤</span> Veldu b√≥k fyrir mig!
                </button>
                <div id="bookOfTheDay" class="bg-white p-4 rounded-2xl border-2 border-dashed border-blue-300 flex items-center gap-3 text-left cursor-pointer hover:bg-blue-50 transition-colors">
                    <span class="text-2xl">üåü</span>
                    <div>
                        <p class="text-xs uppercase font-bold text-gray-400">M√¶lt me√∞ √≠ dag:</p>
                        <p id="botdTitle" class="font-bold text-blue-600 leading-tight">Hle√∞ur...</p>
                    </div>
                </div>
            </div>

            <!-- S√≠ur me√∞ s√©rst√∂kum litum fyrir hvern flokk -->
            <div class="flex flex-wrap justify-center gap-3 mb-6" id="filterContainer">
                <button class="filter-btn active px-4 py-2 rounded-full border-2 border-blue-300 text-blue-600 font-bold hover:bg-blue-50 transition-all" data-filter="all">Allt</button>
                <button class="filter-btn px-4 py-2 rounded-full border-2 border-pink-300 text-pink-600 font-bold hover:bg-pink-50 transition-all" data-filter="samskipti og samb√∂nd">ü§ù Samskipti og samb√∂nd</button>
                <button class="filter-btn px-4 py-2 rounded-full border-2 border-yellow-400 text-yellow-700 font-bold hover:bg-yellow-50 transition-all" data-filter="t√≥nlist">üéµ T√≥nlist</button>
                <button class="filter-btn px-4 py-2 rounded-full border-2 border-green-300 text-green-600 font-bold hover:bg-green-50 transition-all" data-filter="√≠√ær√≥ttir">‚öΩ √ç√ær√≥ttir</button>
                <button class="filter-btn px-4 py-2 rounded-full border-2 border-purple-300 text-purple-600 font-bold hover:bg-purple-50 transition-all" data-filter="√¶vint√Ωri">‚ú® √Üvint√Ωri</button>
                <button class="filter-btn px-4 py-2 rounded-full border-2 border-red-300 text-red-600 font-bold hover:bg-red-50 transition-all" data-filter="spenna">üî• Spenna</button>
                <button class="filter-btn px-4 py-2 rounded-full border-2 border-orange-300 text-orange-600 font-bold hover:bg-orange-50 transition-all" data-filter="fyndi√∞">üòÇ Fyndi√∞</button>
            </div>

            <div class="flex flex-wrap justify-center gap-3 mb-12" id="personalFilterContainer">
                <button class="filter-btn px-6 py-2 rounded-full border-2 border-pink-400 text-pink-600 font-bold hover:bg-pink-50 transition-all flex items-center gap-2" data-filter="favorites">
                    ‚ù§Ô∏è Langar a√∞ lesa
                </button>
                <button class="filter-btn px-6 py-2 rounded-full border-2 border-emerald-400 text-emerald-600 font-bold hover:bg-emerald-50 transition-all flex items-center gap-2" data-filter="read">
                    ‚úÖ B√∫in/n a√∞ lesa
                </button>
            </div>
        </header>

        <div id="bookGrid" class="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-3 xl:grid-cols-4 gap-8"></div>
    </main>

    <footer class="mt-20 p-8 bg-blue-600 text-white text-center rounded-t-[3rem]">
        <p class="text-xl font-bold mb-1">B√≥kasafni√∞ Okkar üìñ</p>
        <p class="opacity-70 text-sm">G√≥√∞a skemmtun √≠ lestrinum!</p>
    </footer>

    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getAuth, signInAnonymously, signInWithCustomToken, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        import { getFirestore, doc, setDoc, onSnapshot } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";

        const firebaseConfig = JSON.parse(__firebase_config);
        const appId = typeof __app_id !== 'undefined' ? __app_id : 'default-book-app';
        
        const app = initializeApp(firebaseConfig);
        const auth = getAuth(app);
        const db = getFirestore(app);

        const SHEET_CSV_URL = 'https://docs.google.com/spreadsheets/d/e/2PACX-1vQ-JqUdG4HMjSgCErU71Pvmlo5HdqqnPQgNxXuANG_oFLLAK3dX-eTD1o6IVpp85KhIa5jDycWQtkZW/pub?output=csv';

        let bookData = [];
        let userData = { favorites: [], read: [] };
        let activeFilter = 'all';
        let searchTerm = '';
        let currentUser = null;
        let unsubscribeUser = null;
        let isAuthReady = false;

        async function initApp() {
            try {
                if (typeof __initial_auth_token !== 'undefined' && __initial_auth_token) {
                    await signInWithCustomToken(auth, __initial_auth_token);
                } else {
                    await signInAnonymously(auth);
                }
            } catch (err) { console.error(err); }
            
            onAuthStateChanged(auth, (user) => {
                if (user) {
                    currentUser = user;
                    isAuthReady = true;
                    listenToUserData(user.uid);
                }
            });
            fetchBooks();
        }

        function listenToUserData(uid) {
            if (!isAuthReady) return;
            if (unsubscribeUser) unsubscribeUser();
            const userDoc = doc(db, 'artifacts', appId, 'public', 'data', 'userCollections', uid);
            unsubscribeUser = onSnapshot(userDoc, (docSnap) => {
                if (docSnap.exists()) {
                    userData = docSnap.data();
                } else {
                    userData = { favorites: [], read: [] };
                }
                updateUI();
            }, (err) => console.error(err));
        }

        async function saveUserData() {
            if (!currentUser || !isAuthReady) return;
            const userDoc = doc(db, 'artifacts', appId, 'public', 'data', 'userCollections', currentUser.uid);
            try { await setDoc(userDoc, userData); } catch (err) { console.error(err); }
        }

        function updateUI() {
            const count = (userData.read && Array.isArray(userData.read)) ? userData.read.length : 0;
            document.getElementById('readCount').innerText = count;
            
            // M√¶listika sett √° 15 b√¶kur
            const progress = Math.min((count / 15) * 100, 100);
            document.getElementById('readingProgress').style.width = `${progress}%`;
            
            if (count > 0 && count % 5 === 0) {
                document.getElementById('starsCounter').classList.add('celebrate');
                setTimeout(() => document.getElementById('starsCounter').classList.remove('celebrate'), 1000);
            }
            
            displayBooks();
        }

        window.toggleStored = async (type, title) => {
            if (!userData[type]) userData[type] = [];
            if (userData[type].includes(title)) {
                userData[type] = userData[type].filter(t => t !== title);
            } else {
                userData[type].push(title);
            }
            updateUI();
            await saveUserData();
        };

        async function fetchBooks() {
            try {
                const response = await fetch(`${SHEET_CSV_URL}&cachebust=${Date.now()}`);
                const data = await response.text();
                parseCSV(data);
                if (bookData.length > 0) {
                    const randomBook = bookData[Math.floor(Math.random() * bookData.length)];
                    document.getElementById('botdTitle').innerText = randomBook.title;
                    document.getElementById('bookOfTheDay').onclick = () => {
                        searchTerm = '';
                        document.getElementById('searchInput').value = '';
                        displayBooks(randomBook.title);
                        const el = document.getElementById(`book-${randomBook.title.replace(/\s+/g, '-')}`);
                        if (el) el.scrollIntoView({ behavior: 'smooth', block: 'center' });
                    };
                }
                displayBooks();
            } catch (e) { console.error(e); }
        }

        function parseCSV(csvText) {
            const lines = csvText.split(/\r?\n/);
            bookData = lines.slice(1).filter(line => line.trim() !== "").map(line => {
                const values = line.match(/(".*?"|[^",\r\n]+)(?=\s*,|\s*$|\s*\r?\n)/g) || [];
                const clean = (val) => val ? val.replace(/^"|"$/g, '').trim() : "";
                return {
                    title: clean(values[0]),
                    url: clean(values[1]),
                    category: clean(values[2]) || "Almennt",
                    img: clean(values[3]),
                    desc: clean(values[5])
                };
            });
        }

        function displayBooks(highlightTitle = null) {
            const bookGrid = document.getElementById('bookGrid');
            if (!bookGrid) return;
            bookGrid.innerHTML = '';
            
            const favorites = userData.favorites || [];
            const readBooks = userData.read || [];

            const filtered = bookData.filter(book => {
                const title = (book.title || "").toLowerCase();
                const category = (book.category || "").toLowerCase();
                const matchesSearch = title.includes(searchTerm);
                let matchesFilter = activeFilter === 'all';
                if (activeFilter === 'favorites') matchesFilter = favorites.includes(book.title);
                else if (activeFilter === 'read') matchesFilter = readBooks.includes(book.title);
                else if (!matchesFilter) matchesFilter = category.includes(activeFilter);
                return matchesSearch && matchesFilter;
            });

            filtered.forEach(book => {
                const isFavorite = favorites.includes(book.title);
                const isRead = readBooks.includes(book.title);
                const isHighlighted = highlightTitle === book.title;

                const card = document.createElement('div');
                card.id = `book-${book.title.replace(/\s+/g, '-')}`;
                card.className = `book-card bg-white rounded-3xl overflow-hidden shadow-lg border-b-8 ${isRead ? 'border-emerald-400' : 'border-blue-400'} h-full cursor-pointer transition-all ${isHighlighted ? 'ring-4 ring-blue-500 scale-105 z-10' : ''}`;
                
                card.onclick = (e) => {
                    if (e.target.closest('button')) return;
                    if (book.url) window.open(book.url, '_blank');
                };

                card.innerHTML = `
                    <div class="h-64 bg-gray-50 relative overflow-hidden flex-shrink-0">
                        <img src="${book.img || 'https://images.unsplash.com/photo-1495446815901-a7297e633e8d?w=400'}" 
                             class="w-full h-full object-contain p-4" referrerpolicy="no-referrer">
                        <div class="absolute top-2 left-2 flex flex-col gap-2 z-20">
                            ${isFavorite ? '<span class="bg-pink-500 text-white px-2 py-1 rounded-lg shadow-lg text-[10px] font-bold">‚ù§Ô∏è Langar</span>' : ''}
                            ${isRead ? '<span class="bg-emerald-500 text-white px-2 py-1 rounded-lg shadow-lg text-[10px] font-bold">‚úÖ Lesin</span>' : ''}
                        </div>
                    </div>
                    <div class="p-6 flex flex-col flex-grow">
                        <div class="flex justify-between items-start mb-3">
                            <span class="text-[10px] font-bold uppercase text-blue-400 tracking-wider">${book.category}</span>
                            <div class="flex gap-4 items-center">
                                <button onclick="window.toggleStored('favorites', '${book.title.replace(/'/g, "\\'")}')" 
                                        class="action-btn text-2xl ${isFavorite ? '' : 'grayscale opacity-30'}">‚ù§Ô∏è</button>
                                <button onclick="window.toggleStored('read', '${book.title.replace(/'/g, "\\'")}')" 
                                        class="action-btn text-2xl ${isRead ? '' : 'grayscale opacity-30'}">‚úÖ</button>
                            </div>
                        </div>
                        <h3 class="text-lg font-bold mb-2 leading-tight">${book.title}</h3>
                        <p class="text-gray-500 text-xs flex-grow description-text italic">${book.desc || "Smelltu til a√∞ hefja lesturinn..."}</p>
                    </div>
                `;
                bookGrid.appendChild(card);
            });
        }

        document.getElementById('userBtn').onclick = () => document.getElementById('authModal').classList.toggle('hidden');
        document.getElementById('authSubmitBtn').onclick = async () => {
            const user = document.getElementById('usernameInput').value.trim();
            const pass = document.getElementById('passwordInput').value.trim();
            if (!user || !pass) return;
            const customUid = `user_${user.toLowerCase().replace(/[^a-z0-9]/g, '')}_${pass}`;
            document.getElementById('userBtn').innerText = `üë§ ${user}`;
            document.getElementById('authModal').classList.add('hidden');
            listenToUserData(customUid);
        };

        document.getElementById('randomBookBtn').onclick = () => {
            const rb = bookData[Math.floor(Math.random() * bookData.length)];
            searchTerm = '';
            document.getElementById('searchInput').value = '';
            displayBooks(rb.title);
            const el = document.getElementById(`book-${rb.title.replace(/\s+/g, '-')}`);
            if (el) el.scrollIntoView({ behavior: 'smooth', block: 'center' });
        };

        document.getElementById('searchInput').oninput = (e) => {
            searchTerm = e.target.value.toLowerCase();
            displayBooks();
        };

        document.querySelectorAll('.filter-btn').forEach(btn => {
            btn.onclick = () => {
                document.querySelectorAll('.filter-btn').forEach(b => b.classList.remove('active'));
                btn.classList.add('active');
                activeFilter = btn.getAttribute('data-filter').toLowerCase();
                displayBooks();
            };
        });

        initApp();
    </script>
</body>
</html>
